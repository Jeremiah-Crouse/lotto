<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sovereign 24: Texas Advice</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #00ff41; font-family: 'Courier New', Courier, monospace; }
        #header { position: sticky; top: 0; height: 60px; padding: 10px; border-bottom: 2px solid #00ff41; background: #000; text-align: center; z-index: 100; }
        #scroll-list { padding: 10px; }
        .row { 
            height: 80px; border-bottom: 1px solid #1a1a1a; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-sizing: border-box;
        }
        .claimed { color: #444 !important; text-decoration: line-through; pointer-events: none; opacity: 0.5; }
        .claim-btn { 
            background: #00ff41; color: #000; border: none; padding: 10px 15px; 
            font-weight: bold; cursor: pointer; border-radius: 4px;
        }
        #loading { text-align: center; padding: 20px; color: #888; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div id="header">SOVEREIGN 24: TX ONLY</div>
    <div id="scroll-list"></div>
    <div id="loading">Connecting to Sovereign Tunnel...</div>

<script>
    // --- SETTINGS ---
    const VM_IP = "https://eileen-copious-magnetooptically.ngrok-free.dev"; // e.g., https://a1b2-c3d4.ngrok-free.app
    const HEADERS = {
        "Content-Type": "application/json",
        "ngrok-skip-browser-warning": "true" // THIS IS THE FIX
    };

    let offset = 0;
    let loading = false;
    const listElement = document.getElementById('scroll-list');

    async function loadBatch() {
        if (loading) return;
        loading = true;
        try {
            console.log(`Fetching batch at offset ${offset}...`);
            const res = await fetch(`${VM_IP}/more?offset=${offset}`, {
                method: 'GET',
                headers: HEADERS
            });
            
            if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
            
            const tickets = await res.json();
            
            if (tickets.length === 0) {
                document.getElementById('loading').innerText = "END OF ACTIVE ROSTER";
                return;
            }

            tickets.forEach(ticket => {
                const div = document.createElement('div');
                div.className = 'row' + (ticket.claimed ? ' claimed' : '');
                div.innerHTML = `
                    <span>${ticket.numbers}</span>
                    <button class="claim-btn" onclick="claim(${ticket.id}, this)">${ticket.claimed ? 'TAKEN' : 'CLAIM'}</button>
                `;
                listElement.appendChild(div);
            });

            offset += tickets.length;
            document.getElementById('loading').innerText = `Loaded ${offset} tickets. Scroll for more...`;
        } catch (e) {
            console.error("Critical Load Error:", e);
            document.getElementById('loading').innerText = "TUNNEL BLOCKED OR OFFLINE";
        }
        loading = false;
    }

    async function claim(id, btnElement) {
        if (!confirm("Claim this ticket? (TX Residents Only)")) return;
        
        try {
            const res = await fetch(`${VM_IP}/claim`, {
                method: 'POST',
                headers: HEADERS,
                body: JSON.stringify({ id: id })
            });
            
            if (res.ok) {
                btnElement.parentElement.classList.add('claimed');
                btnElement.innerText = "TAKEN";
                btnElement.disabled = true;
            } else {
                alert("Claim rejected by Sovereign Node.");
            }
        } catch (e) {
            console.error("Claim Error:", e);
            alert("Connection lost during claim.");
        }
    }

    // Infinite Scroll logic
    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 800) {
            loadBatch();
        }
    };

    // Kickoff
    loadBatch();
</script>
</body>
</html>

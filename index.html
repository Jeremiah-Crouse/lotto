<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Echadian Commonwealth : Confluence Industrial</title>
    <style>
        :root { 
            --neon: #00ff41; --bg: #0a0a0a; --dim: #004411; 
            --bronze: #cd7f32; --silver: #c0c0c0; --gold: #ffd700; --platinum: #e5e4e2;
        }
        body { margin: 0; background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; overflow-x: hidden; padding-bottom: 70px; }
        
        #header { position: sticky; top: 0; height: 60px; background: #000; border-bottom: 2px solid var(--neon); display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 1000; }
        
        #market-stats { padding: 10px; background: #000; border-bottom: 1px solid #222; font-size: 0.7rem; color: #888; line-height: 1.4; }
        .stat-box { border-left: 1px solid #222; padding-left: 10px; flex: 1; }
        .stat-label { display:block; color: #555; font-size: 0.6rem; }

        #tabs { display: flex; background: #000; border-bottom: 1px solid var(--neon); position: sticky; top: 60px; z-index: 1000; }
        .tab-btn { flex: 1; padding: 15px; text-align: center; border: none; background: none; color: var(--dim); font-weight: bold; cursor: pointer; font-size: 0.7rem; }
        .tab-btn.active { color: var(--neon); border-bottom: 3px solid var(--neon); }

        #controls { position: sticky; top: 110px; background: #111; padding: 12px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 10px; z-index: 999; }
        .search-container { display: flex; gap: 10px; }
        #ticket-search { flex: 1; background: #000; border: 1px solid var(--dim); color: var(--neon); padding: 12px; font-family: inherit; font-size: 1rem; }
        
        /* Tier Badges */
        .tier-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; font-weight: bold; margin-left: 8px; text-transform: uppercase; vertical-align: middle; }
        .tier-1 { border: 1px solid var(--bronze); color: var(--bronze); }
        .tier-2 { border: 1px solid var(--silver); color: var(--silver); }
        .tier-3 { border: 1px solid var(--gold); color: var(--gold); }
        .tier-4 { border: 1px solid var(--platinum); color: var(--platinum); box-shadow: 0 0 5px var(--platinum); }

        .row { height: 110px; border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .ticket-id { font-size: 1.1rem; color: #888; font-weight: 400; margin-bottom: 4px; }
        .ticket-numbers { font-size: 1.1rem; color: var(--neon); font-weight: bold; }
        
        .claimed { opacity: 0.6; }
        .claim-btn { background: var(--neon); color: #000; border: none; padding: 12px 18px; font-weight: bold; cursor: pointer; min-width: 95px; border-radius: 2px; }
        .unclaim-btn { background: #ff0041; color: #fff; border: none; padding: 8px 12px; font-size: 0.65rem; font-weight: bold; cursor: pointer; margin-top: 5px; width: 100%; border-radius: 2px; }
        .copy-btn { background: #333; color: #fff; border: 1px solid #444; padding: 10px 14px; font-size: 0.75rem; cursor: pointer; font-weight: bold; margin-left: 10px; border-radius: 2px; }
        
        #footer-counter { position: fixed; bottom: 0; width: 100%; background: var(--neon); color: #000; text-align: center; font-size: 0.75rem; font-weight: bold; padding: 12px 0; z-index: 1001; }
        #loading-indicator { text-align: center; padding: 20px; color: #444; font-size: 0.8rem; display: none; }
        
        #tier-filters { display: flex; gap: 5px; justify-content: space-around; padding-bottom: 5px; }
        .tier-filter-btn { background: #000; border: 1px solid #333; color: #666; font-size: 0.6rem; padding: 5px; flex: 1; border-radius: 3px; }
        .tier-filter-btn.active { border-color: var(--neon); color: var(--neon); }
    </style>
</head>
<body>

    <div id="header">SOVEREIGN 24 ⭐ CONFLUENCE INDUSTRIAL</div>

    <div id="market-stats">
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div style="flex: 1;">
                <span class="stat-label">LIVE BOUNTY</span>
                <span id="jackpot-est" style="color: gold; font-weight: bold; font-size: 0.9rem;">LOADING...</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">PULSE</span>
                <span id="system-pulse" style="color: #00ff41; font-weight: bold; font-size: 0.9rem;">OPTIMAL (+EV)</span>
            </div>
        </div>
    </div>
    
    <div id="tabs">
        <button class="tab-btn active" onclick="switchTab('roster')">ROSTER</button>
        <button class="tab-btn" onclick="switchTab('audit')">AUDIT</button>
        <button class="tab-btn" onclick="switchTab('contact')">CONTACT</button>
    </div>

    <div id="roster-view">
        <div id="controls">
            <div class="search-container">
                <input type="text" id="ticket-search" placeholder="Search numbers (e.g. 34 41)..." oninput="handleSearch(this.value)">
            </div>
            <div id="tier-filters">
                <button class="tier-filter-btn active" id="f-all" onclick="setTierFilter(null)">ALL</button>
                <button class="tier-filter-btn" id="f-1" onclick="setTierFilter(1)">BRONZE</button>
                <button class="tier-filter-btn" id="f-2" onclick="setTierFilter(2)">SILVER</button>
                <button class="tier-filter-btn" id="f-3" onclick="setTierFilter(3)">GOLD</button>
                <button class="tier-filter-btn" id="f-4" onclick="setTierFilter(4)">PLATINUM</button>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.65rem;">
                <label><input type="checkbox" id="filter-available" onchange="render()"> ONLY AVAILABLE</label>
                <span id="tier-stat-display">CONFLUENCE: ON</span>
            </div>
        </div>
        <div id="scroll-list"></div>
        <div id="loading-indicator">SYNCING QUAD-TIER DATABASE...</div>
    </div>

    <div id="audit-log" style="padding: 20px; display: none;">
        <div id="audit-list">SYNCING HISTORICAL LOGS...</div>
    </div>

    <div id="contact-view" style="padding: 20px; display: none;">
        <div class="contact-card">
            <h3>STATUS MANAGEMENT</h3>
            <p>If you mistakenly claimed a ticket or need a reset:</p>
            <p>EMAIL: <a href="mailto:jeremiahjcrouse@gmail.com" class="email-link">jeremiahjcrouse@gmail.com</a></p>
            <p style="font-size: 0.75rem; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                <b>PLATINUM OVERLAP:</b> These tickets hit across 4 different DNA strands. They represent the highest mathematical confluence in the system.
            </p>
        </div>
    </div>

    <div id="footer-counter">INITIALIZING VM LINK...</div>

<script>
    const VM_IP = "https://eileen-copious-magnetooptically.ngrok-free.dev"; 
    const HEADERS = { "ngrok-skip-browser-warning": "true", "Content-Type": "application/json" };

    let rosterCache = []; 
    let offset = 0;
    let loading = false;
    let currentSearch = "";
    let currentTier = null;

    const TIER_NAMES = { 1: 'Bronze', 2: 'Silver', 3: 'Gold', 4: 'Platinum' };

    async function updateMarket() {
        try {
            const res = await fetch(`${VM_IP}/status`, { headers: HEADERS });
            const s = await res.json();
            document.getElementById('jackpot-est').innerText = s.jackpot || "$323 Million";
            
            const total = Object.values(s.tiers).reduce((a, b) => a + b, 0);
            document.getElementById('footer-counter').innerText = `LIVE | TIERS: P:${s.tiers.Tier_4 || 0} G:${s.tiers.Tier_3 || 0} S:${s.tiers.Tier_2 || 0} | TOTAL: ${total.toLocaleString()}`;
        } catch (e) {
            document.getElementById('footer-counter').innerText = "OFFLINE - RECHECK VM";
            document.getElementById('footer-counter').style.background = "#ff0041";
        }
    }
    
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        ['roster-view', 'audit-log', 'contact-view'].forEach(id => document.getElementById(id).style.display = 'none');
        if (tab === 'roster') {
            document.getElementById('roster-view').style.display = 'block';
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        } else if (tab === 'audit') {
            document.getElementById('audit-log').style.display = 'block';
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        } else {
            document.getElementById('contact-view').style.display = 'block';
            document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
        }
    }

    function setTierFilter(tier) {
        document.querySelectorAll('.tier-filter-btn').forEach(b => b.classList.remove('active'));
        const btnId = tier ? `f-${tier}` : 'f-all';
        document.getElementById(btnId).classList.add('active');
        currentTier = tier;
        offset = 0;
        rosterCache = [];
        render();
        loadBatch();
    }

    let searchTimeout;
    function handleSearch(val) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = val.trim();
            offset = 0;
            rosterCache = [];
            render(); 
            loadBatch();
        }, 400);
    }

    function render() {
        const list = document.getElementById('scroll-list');
        const showAvail = document.getElementById('filter-available').checked;
        list.innerHTML = "";

        rosterCache.forEach(t => {
            if (showAvail && t.claimed) return;

            const div = document.createElement('div');
            div.className = 'row' + (t.claimed ? ' claimed' : '');
            const displayId = t.id.toString().padStart(6, '0');
            
            div.innerHTML = `
                <div>
                    <div class="ticket-id">#${displayId} <span class="tier-badge tier-${t.tier}">${TIER_NAMES[t.tier]}</span></div>
                    <div class="ticket-numbers">⭐ ${t.numbers}</div>
                </div>
                <div style="text-align: right;">
                    <button class="claim-btn" ${t.claimed ? 'disabled' : ''} onclick="claim(${t.id})">
                        ${t.claimed ? 'TAKEN' : 'CLAIM'}
                    </button>
                    ${t.claimed ? `<button class="unclaim-btn" onclick="unclaim(${t.id})">RESET (UNCLAIM)</button>` : ''}
                </div>`;
            list.appendChild(div);
        });
    }

    async function claim(id) {
        try {
            const res = await fetch(`${VM_IP}/claim`, {
                method: 'POST',
                headers: HEADERS,
                body: JSON.stringify({ id: id })
            });
            if (res.ok) {
                const idx = rosterCache.findIndex(t => t.id === id);
                if (idx !== -1) rosterCache[idx].claimed = true;
                render();
                updateMarket();
            }
        } catch (e) { alert("CLAIM FAILED"); }
    }

    async function unclaim(id) {
        if(!confirm("Are you sure you want to unclaim this seat?")) return;
        try {
            const res = await fetch(`${VM_IP}/unclaim`, {
                method: 'POST',
                headers: HEADERS,
                body: JSON.stringify({ id: id })
            });
            if (res.ok) {
                const idx = rosterCache.findIndex(t => t.id === id);
                if (idx !== -1) rosterCache[idx].claimed = false;
                render();
                updateMarket();
            }
        } catch (e) { alert("UNCLAIM FAILED"); }
    }

    async function loadBatch() {
        if (loading) return;
        loading = true;
        document.getElementById('loading-indicator').style.display = 'block';

        try {
            let url = `${VM_IP}/more?offset=${offset}`;
            if (currentSearch) url += `&q=${encodeURIComponent(currentSearch)}`;
            if (currentTier) url += `&tier=${currentTier}`;
            
            const res = await fetch(url, { headers: HEADERS });
            const data = await res.json();
            
            if (data.length > 0) {
                rosterCache.push(...data);
                offset += 100;
                render();
            }
        } catch (e) { console.error("Sync Error", e); }
        
        loading = false;
        document.getElementById('loading-indicator').style.display = 'none';
    }

    window.onscroll = () => {
        if (document.getElementById('roster-view').style.display !== 'none' && 
            (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 800) {
            loadBatch();
        }
    };

    updateMarket();
    loadBatch();
    setInterval(updateMarket, 60000);
</script>
</body>
</html>

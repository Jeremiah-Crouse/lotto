<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sovereign 24: Texas Industrial</title>
    <style>
        :root { --neon: #00ff41; --bg: #0a0a0a; --dim: #004411; }
        body { margin: 0; background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; overflow-x: hidden; }
        #header { position: sticky; top: 0; height: 60px; background: #000; border-bottom: 2px solid var(--neon); display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 1000; }
        
        #market-stats { padding: 10px; background: #000; border-bottom: 1px solid #222; font-size: 0.7rem; color: #888; line-height: 1.4; }
        .stat-box { border-left: 1px solid #222; padding-left: 10px; flex: 1; }
        .stat-label { display:block; color: #555; font-size: 0.6rem; }

        #tabs { display: flex; background: #000; border-bottom: 1px solid var(--neon); position: sticky; top: 60px; z-index: 1000; }
        .tab-btn { flex: 1; padding: 15px; text-align: center; border: none; background: none; color: var(--dim); font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .tab-btn.active { color: var(--neon); border-bottom: 3px solid var(--neon); }

        #controls { position: sticky; top: 110px; background: #111; padding: 12px; border-bottom: 1px solid #333; display: flex; justify-content: space-around; font-size: 0.7rem; z-index: 999; }
        .row { height: 75px; border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .claimed { opacity: 0.2; text-decoration: line-through; filter: grayscale(1); pointer-events: none; }
        .claim-btn { background: var(--neon); color: #000; border: none; padding: 10px 16px; font-weight: bold; cursor: pointer; }
        
        #audit-log { padding: 20px; display: none; }
        .audit-entry { border: 1px solid var(--dim); padding: 10px; margin-bottom: 10px; font-size: 0.8rem; border-left: 5px solid var(--dim); }
        .audit-entry.JACKPOT { border-color: var(--neon); border-left: 5px solid gold; color: white; background: #003300; }
        .audit-entry.TIER_2 { border-color: #00ccff; border-left: 5px solid #00ccff; }

        #footer-counter { position: fixed; bottom: 0; width: 100%; background: var(--neon); color: #000; text-align: center; font-size: 0.8rem; font-weight: bold; padding: 8px 0; z-index: 1001; }
        #border-warning { color: red; text-align: center; margin-top: 100px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="header">SOVEREIGN 24 ‚≠ê TEXAS INDUSTRIAL</div>

    <div id="market-stats">
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div style="flex: 1;">
                <span class="stat-label">LIVE BOUNTY</span>
                <span id="jackpot-est" style="color: gold; font-weight: bold; font-size: 0.9rem;">FETCHING...</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">ANNUAL TARGET</span>
                <span id="annual-expectancy" style="color: var(--neon); font-weight: bold; font-size: 0.9rem;">$75.1M</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">MY EQUITY (+EV)</span>
                <span id="personal-share" style="color: #ff00ff; font-weight: bold; font-size: 0.9rem;">$0.00</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">PULSE</span>
                <span id="system-pulse" style="color: #00ccff; font-weight: bold; font-size: 0.9rem;">STABLE</span>
            </div>
        </div>
    </div>
    
    <div id="tabs">
        <button class="tab-btn active" onclick="switchTab('roster')">TICKET ROSTER</button>
        <button class="tab-btn" onclick="switchTab('audit')">INDUSTRIAL AUDIT</button>
    </div>

    <div id="roster-view">
        <div id="controls">
            <label><input type="checkbox" id="filter-available" onchange="render()"> ONLY AVAILABLE</label>
            <label><input type="checkbox" id="shuffle-mode"> SNOWBALL SHUFFLE</label>
        </div>
        <div id="scroll-list"></div>
        <div id="loading" style="text-align:center; padding:20px; color:#444;">SYNCING...</div>
    </div>

    <div id="audit-log">
        <div id="audit-list">SYNCING HISTORICAL LOGS...</div>
    </div>

    <div id="footer-counter">CONNECTING...</div>

<script>
    const VM_IP = "https://eileen-copious-magnetooptically.ngrok-free.dev"; 
    const HEADERS = { "ngrok-skip-browser-warning": "true", "Content-Type": "application/json" };

    let rosterCache = []; 
    let offset = 0;
    let loading = false;
    let borderBlocked = false;
    
    // PERSISTENCE: Initialize claims from Browser Local Storage
    let ticketsClaimed = parseInt(localStorage.getItem('sovereign_claims')) || 0;

    async function updateMarket() {
        try {
            const res = await fetch(`${VM_IP}/status`, { headers: HEADERS });
            const s = await res.json();
            
            const jpDisplay = s.live_jackpot || "$323 Million";
            document.getElementById('jackpot-est').innerText = jpDisplay;
            
            // --- THE PRAXIS "HARD TRUTH" MATH ---
            // 1. Convert string bounty to raw integer
            const rawJp = parseInt(jpDisplay.replace(/[^0-9]/g, "")) * 1000000;
            
            // 2. The 1/90th Temporal Probability Slice (The Gap Average)
            const drawValue = rawJp / 90; 
            
            // 3. The 1/467,544th Equity Slice (Individual Ticket Share)
            const totalTickets = s.total || 467544;
            const equityPerTicket = drawValue / totalTickets; // ~$7.67
            
            // 4. Calculate Personal Equity Capture using PERSISTED count
            const myTotalEquity = ticketsClaimed * equityPerTicket;
            
            // Update UI
            document.getElementById('personal-share').innerText = `$${myTotalEquity.toFixed(2)}`;
            document.getElementById('personal-share').title = `Equity: $${equityPerTicket.toFixed(2)} per ticket`;
            document.getElementById('annual-expectancy').innerText = s.annual_expectancy || "$75.1M";
    
            // Pulse Logic
            const pulse = document.getElementById('system-pulse');
            if (rawJp > 400000000) {
                pulse.innerText = "HIGH PRESSURE";
                pulse.style.color = "red";
            } else {
                pulse.innerText = "OPTIMAL (+EV)";
                pulse.style.color = "#00ff41";
            }
        } catch (e) { console.log("Market Sync Error", e); }
    }
    
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if (tab === 'roster') {
            document.getElementById('roster-view').style.display = 'block';
            document.getElementById('audit-log').style.display = 'none';
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        } else {
            document.getElementById('roster-view').style.display = 'none';
            document.getElementById('audit-log').style.display = 'block';
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            loadAudit();
        }
    }

    async function loadAudit() {
        try {
            const res = await fetch(`${VM_IP}/audit`, { headers: HEADERS });
            const data = await res.json();
            const container = document.getElementById('audit-list');
            container.innerHTML = "";
            data.history.reverse().forEach((row, i) => {
                if (row[0] === "Date") return;
                const div = document.createElement('div');
                div.className = `audit-entry ${row[1]}`;
                div.innerHTML = `<div>[${row[0]}] <b>${row[1]}</b></div><div>${row[2]} | ${row[3]}</div>`;
                container.appendChild(div);
            });
        } catch (e) { document.getElementById('audit-list').innerText = "AUDIT OFFLINE"; }
    }

    async function updateStatus() {
        if(borderBlocked) return;
        try {
            const res = await fetch(`${VM_IP}/status`, { headers: HEADERS });
            const s = await res.json();
            document.getElementById('footer-counter').innerText = `AVAIL: ${s.remaining.toLocaleString()} / TOTAL: ${s.total.toLocaleString()} | COST: ${s.roster_cost}`;
        } catch (e) {}
    }

    async function loadBatch() {
        if (loading || borderBlocked) return;
        loading = true;
        try {
            const res = await fetch(`${VM_IP}/more?offset=${offset}`, { headers: HEADERS });
            if (res.status === 403) {
                borderBlocked = true;
                document.getElementById('roster-view').innerHTML = `<div id="border-warning"><h1>üõë BORDER PROTECTION</h1><p>ACCESS RESTRICTED TO TEXAS RESIDENTS ONLY.</p></div>`;
                return;
            }
            const data = await res.json();
            if (data.length > 0) {
                rosterCache.push(...data);
                offset += 100;
                render();
            }
        } catch (e) {}
        loading = false;
    }

    function render() {
        const list = document.getElementById('scroll-list');
        const showAvail = document.getElementById('filter-available').checked;
        list.innerHTML = "";
        rosterCache.forEach(t => {
            if (showAvail && t.claimed) return;
            const div = document.createElement('div');
            div.className = 'row' + (t.claimed ? ' claimed' : '');
            div.innerHTML = `<span>‚≠ê ${t.numbers}</span>
                <button class="claim-btn" ${t.claimed ? 'disabled' : ''} onclick="claim(${t.id})">
                    ${t.claimed ? 'TAKEN' : 'CLAIM'}
                </button>`;
            list.appendChild(div);
        });
    }

    async function claim(id) {
        try {
            const res = await fetch(`${VM_IP}/claim`, {
                method: 'POST',
                headers: HEADERS,
                body: JSON.stringify({ id: id })
            });
            if (res.ok) {
                // 1. Update local count
                ticketsClaimed++;
                
                // 2. Persist to browser memory
                localStorage.setItem('sovereign_claims', ticketsClaimed);
                
                const idx = rosterCache.findIndex(t => t.id === id);
                if (idx !== -1) rosterCache[idx].claimed = true;
                
                render();
                updateStatus();
                updateMarket(); // Recalculate equity immediately
            }
        } catch (e) { alert("CLAIM FAILED: Check connection."); }
    }

    window.onscroll = () => {
        if (document.getElementById('roster-view').style.display !== 'none' && 
            (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1500) loadBatch();
    };

    // Initial Execution
    updateMarket();
    updateStatus();
    loadBatch();
    
    // Intervals
    setInterval(updateMarket, 60000);
    setInterval(updateStatus, 30000);
</script>
</body>
</html>

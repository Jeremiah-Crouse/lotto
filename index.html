<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sovereign 24: Texas Advice</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #00ff41; font-family: 'Courier New', Courier, monospace; }
        #header { position: sticky; top: 0; height: 60px; padding: 10px; border-bottom: 2px solid #00ff41; background: #000; text-align: center; z-index: 100; }
        #scroll-list { padding: 10px; }
        .row { 
            height: 80px; border-bottom: 1px solid #1a1a1a; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-sizing: border-box;
        }
        .claimed { color: #444; text-decoration: line-through; pointer-events: none; opacity: 0.5; }
        .claim-btn { 
            background: #00ff41; color: #000; border: none; padding: 10px 15px; 
            font-weight: bold; cursor: pointer; border-radius: 4px;
        }
        #loading { text-align: center; padding: 20px; color: #888; }
    </style>
</head>
<body>
    <div id="header">SOVEREIGN 24: TX ONLY</div>
    <div id="scroll-list"></div>
    <div id="loading">Scanning Machine Signature...</div>

<script>
    const VM_IP = "https://eileen-copious-magnetooptically.ngrok-free.dev:8000"; // REPLACE WITH YOUR ACTUAL VM IP
    let offset = 0;
    let loading = false;
    const listElement = document.getElementById('scroll-list');

    // 1. Fetch data from the VM /more endpoint
    async function loadBatch() {
        if (loading) return;
        loading = true;
        try {
            const res = await fetch(`${VM_IP}/more?offset=${offset}`);
            const tickets = await res.json();
            
            if (tickets.length === 0) {
                document.getElementById('loading').innerText = "END OF ROSTER";
                return;
            }

            tickets.forEach(ticket => {
                const div = document.createElement('div');
                div.className = 'row' + (ticket.claimed ? ' claimed' : '');
                div.innerHTML = `
                    <span>${ticket.numbers}</span>
                    <button class="claim-btn" onclick="claim(${ticket.id}, this)">${ticket.claimed ? 'TAKEN' : 'CLAIM'}</button>
                `;
                listElement.appendChild(div);
            });

            offset += tickets.length;
        } catch (e) {
            console.error("Connection failed", e);
            document.getElementById('loading').innerText = "SERVER OFFLINE";
        }
        loading = false;
    }

    // 2. Claim Logic (Talks to the VM /claim endpoint)
    async function claim(id, btnElement) {
        if (!confirm("Claim this ticket? (TX Residents Only)")) return;
        
        try {
            const res = await fetch(`${VM_IP}/claim`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            if (res.ok) {
                btnElement.parentElement.classList.add('claimed');
                btnElement.innerText = "TAKEN";
                btnElement.disabled = true;
            }
        } catch (e) {
            alert("Claim failed. Check server connection.");
        }
    }

    // 3. Infinite Scroll Listener
    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadBatch();
        }
    };

    // Initial Load
    loadBatch();
</script>
</body>
</html>
